name: flatpak

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flatpak tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder skopeo

      - name: Add Flathub
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install SDKs
        run: |
          sudo flatpak install -y flathub org.gnome.Platform//48 org.gnome.Sdk//48
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.rust-stable//24.08

      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir flatpak/lt.gtw.idxd.json

      - name: Export OCI layout
        run: |
          flatpak build-export --oci oci repo

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push to GHCR
        run: |
          skopeo copy oci:oci "docker://ghcr.io/${{ github.repository }}:main"
